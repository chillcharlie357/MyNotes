
# 转储方法

## 静态转储

- 在系统中<font color="#ff0000">无运行事务时进行</font>的转储操作（可以查，不可以增删改）
- 转储开始时数据库处于一致性状态
- 转储期间不允许对数据库的任何存取、修改活动
- 得到的一定是一个数据一致性的副本 

优点：实现简单
缺点：备份时需要把业务停下来

## 动态转储
随时随地备份

- 转储操作与用户事务并发进行
- 转储期间允许对数据库进行存取或修改

- 优点:
	- 不用等待正在运行的用户事务结束
	- 不会影响新事务的运行

- 缺点：
	- 恢复出来的数据不能保证一致
	- 备份数据可能过时

所以需要日志文件


# 日志文件

- 日志文件(log file)是用来记录事务对数据库的更新操作的文件
- 日志文件的格式
	- 以记录为单位的日志文件
	- 以数据块为单位的日志文件
- 用途
	- 进行事务故障恢复
	- 进行系统故障恢复
	- 协助后备副本进行介质故障恢复


## 以记录为单位的日志文件

- 日志文件中的一个日志记录 (log  record)包含
	- 各个事务的开始标记(BEGIN TRANSACTION)
	- 各个事务的结束标记(COMMIT或ROLLBACK)
	- 各个事务的所有更新操作


- 内容
	- 事务标识（标明是哪个事务） 
	- 操作类型（插入、删除或修改）
	- 操作对象（记录内部标识）
	- 更新前数据的旧值（对插入操作而言，此项为空值）
	- 更新后数据的新值（对删除操作而言, 此项为空值）

## 以数据块为单位的日志文件

- 内容
	- 事务标识
	- 被更新的数据块

## 日志文件的作用


1. 动态转储必须建立日志文件
2. 事务故障恢复和系统故障恢复必须用日志文件

![](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/imgae/2023/05/09/bd3c95237e4fc45a63e7cbacc9c9a46d_Pasted%20image%2020230509170235.png)


## 登记日志文件

### 原则

1. 登记的次序严格按并发事务执行的时间次序
2. 必须先写日志文件，后写数据库
	- 写日志文件操作：把表示这个修改的日志记录写到日志文件中
	- 写数据库操作：把对数据的修改写到数据库中

### 为什么要先写日志文件

- 写数据库和写日志文件是两个不同的操作
- 在这两个操作之间可能发生故障
- 如果先写了数据库修改，而在日志文件中没有登记下这个修改，则以后就无法恢复这个修改了（<font color="#ff0000">改数据库必须要先写日志文件</font>）
- 如果先写日志，但没有修改数据库，按日志文件恢复时只不过是多执行一次不必要的UNDO操作，并不会影响数据库的正确性

# 恢复策略

## 事务故障的恢复

事务故障：事务在运行至正常终止点前被终止
恢复方法：UNDO
事务故障的恢复由系统自动完成，对用户是透明的，不需要用户干预


### 恢复步骤

1. 反向扫描文件日志，查找该事务的更新操作。
2. 对该事务的更新操作执行逆操作。即将日志记录中“更新前的值” 写入数据库。
3. 继续反向扫描日志文件，查找该事务的其他更新操作，并做同样处理。
4. 如此处理下去，直至读到此事务的开始标记，事务故障恢复就完成了。

## 系统故障的恢复

不是把事务重新执行一遍，而是更具事务的结果直接恢复数据库（跳过计算、分支等）

REDO+UNDO

## 介质故障的恢复

需要人为介入

