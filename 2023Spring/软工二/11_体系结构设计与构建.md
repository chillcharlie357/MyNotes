
# 体系结构设计

## 过程

1. 分析关键需求和项⽬约束；
2. 通过选择体系结构⻛格；
3. 进⾏软件体系结构逻辑（抽象）设计；
4. 依赖逻辑设计进⾏软件体系结构（实现）设计；
5. 完善体系结构设计；
6. 添加构件接⼝；
7. 迭代过程3-7

## 需求

- 非功能需求：越复杂的系统中越重要
	- 质量 
	- 性能 
	 - 约束
	 - 接⼝
 - 项⽬约束
- 功能需求

## 风格

- 通常采用分层
	- 协议不变情况下易于修改
	- 能够促进并⾏开发


## 逻辑（抽象）设计

- 将需求分配到⼦系统和模块
	- 复杂系统：下一级为子系统;简单系统：下一级为模块
	- 考虑功能相同性
	- 考虑可复用性


## 物理包设计原则

- Reuse-Release Equivalency Principle
- Common Closure Principle
- Common Reuse Principle
- Acyclic Dependencies Principles
- Stable Dependencies Principles
- Stable Abstractions Principles

### Common Closure Principle (CCP) 共同封闭原则

- <font color="#ff0000">需要共同修改的类应该放在一起</font>
- 最小化修改影响

#### 总结

- 包会变大，但会变少
- 会减少修改

### Common Reuse Principle (CRP) 共同重⽤原则

- <font color="#ff0000">一起用的类放在一起</font>
- 复用单元

#### 总结

- 根据共同重用把类放在一起
	- 减少不必要的依赖
- 会把类分成许多包
- 可以更多复用

初期考虑CCP，开发后期考虑CRP  

分包：按照功能来分更加合理

### Reuse-Release Equivalency Principle (REP) 重⽤发布等价原则

- <font color="#ff0000">重用单元就是发布单元</font>


### The Acyclic Dependencies Principle (ADP) ⽆环依赖原则

- 依赖关系是DAG有向无环图

依赖就是使用

#### 消除环

- 拆分包
![](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/imgae/2023/04/23/99ea5dc62ea0efd38958919035319efb_202304231125642.png)
![](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/imgae/2023/04/23/49ee05b92c93aa8c5d9f69a0543caa3e_202304231125050.png)

- 循环依赖改成接口
![](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/imgae/2023/04/23/2a9f48b07273f05bea65123a015fba1f_202304231124261.png)

### Stable Dependencies Principle (SDP) 稳定依赖原则

- <font color="#ff0000">依赖指向稳定的方向</font>

#### 稳定性度量

- （Ca ）输⼊耦合度（Afferent Coupling）：指处于该包的外部并依赖于该包内 的类的类的数⽬
- （Ce ）输出耦合度（Efferent Coupling）：指处于该包的内部并依赖于该包外 的类的类的数⽬
- 不稳定性I = Ce / (Ca + Ce)
	- I=0表示该包具有最⼤的稳定性。I=1表示该包具有最⼤的 不稳定性。


### Stable Abstractions Principle (SAP) 稳定抽象原则

- 稳定包应该是抽象的

#### 抽象性度量

- 假如说包中类的总数是Nc, 抽象类的数⽬是Na ,那么抽象度A = Na/Nc

越不稳定越具体，越稳定越抽象


string类具体类，但很稳定

离线越近越合理
![](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/imgae/2023/04/23/0848f1aa0dbc2cfe2193ac13496b103f_202304231137220.png)


## 物理包设计过程

- 迭代的过程
	- 先CCP 原则对把可能⼀同变化的类组织成包进⾏发布,
	- 随着系统的不断增⻓,我们开始关注创建可重⽤的元素,于是开始使⽤ CRP 和 REP 来指导包的组合。
	- 最后使⽤ ADP、SDP、SAP 对包图进⾏度量，去掉不好的依赖

## 接口定义

<font color="#ff0000">定义接口考试一定会写</font>



- 逻辑层接口：根据需求定，刺激是输入参数，响应是返回值
- 数据层接口：看逻辑层对数据的需求，逻辑层有什么需求数据层就提供什么样的服务
	- 主要是对数据增删改查，但不是所有逻辑层操作都需要增删改查。如：会计系统的红冲，不提供删除操作。

![](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/imgae/2023/04/25/c8eae4afbe2562cf2bf0c0af1821438c_202304251031934.png)


- 逻辑层接口（不同逻辑层可以相互交互）

```java
ReceiptVO[ ] firstStepShowList(String UserID);//UserID指的是审核⼈是谁
ReceiptDetailVO firstStepShowDetail(String UserID, String receiptID)
void firstExamine(ExamineVo[ ] list);//ExamineVo的内容：{receiptID result}
ReceiptVO[ ] SecondStepShowList(String UserID);//如果只有⼀个总经理，可能这个参数就不需要。
ReceiptDetailVO SecondStepShowDetail(String UserID, String receiptID)
ReceiptDetailVO EditDetail(String UserID, String receiptID)
void SecondExamine(ExamineVo[ ])
```
- 数据层接口（只需要处理自己的数据）

销售的数据层不应该访问商品的数据，如果有需要应该在逻辑层已经完成

```java
interface ExamineLogicalService {
	Pair<Bollean, Bill> examine(Bill bill);
	List<Bill> showTodoBills(SecurityLevel securityLevel);
	BillDetail showBillDetail(Bill bill);
	void editBill(Bill bill, Inf inf);
	Pair<Bollean, List<Bill>> tagBillsAndExamine(List<Bill> bills);
}
```

```java
interface ExamineDataService {
	Exception setPassed(Bill bill, Bollean passed);
	Exception setInf(Bill bill, Inf inf); 
}
```

```java
interface BillDataService{
	List<Bill> getTodoBills(SecurityLevel securityLevel);
	BillDetail getBillDetail(Bill bill);
}
```


# 体系结构构建

- 包创建
- 重要⽂件的创建
- 定义构件之间的接⼝
- 关键需求的实现


# 体系结构集成与测试


## 集成策略


- stub桩：对接口假的实现，要什么数据给什么数据
	- 为了完成程序的编译和连接⽽使⽤的暂时代码
	- 对外模拟和代替承担模块接⼝的关键类
	- ⽐真实程序简单的多，使⽤最为简单的逻辑
- driver：对接口假的调用


### 自顶向下

- 自顶向下集成的优点:
	- 按深度优先可以首先实现和验证一个完整的 功能需求;
	- 只需最顶端一个驱动(Driver);
	- 利于故障定位。
- 自顶向下集成的缺点:
	- 桩的开发量大;
	- 底层验证被推迟,且底层组件测试不充分

![](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/imgae/2023/04/25/9d9d76325f88888a2b0ddabceee64387_202304251049497.png)

### ⾃底向上

### 持续集成

包含尽早集成和频繁集成

- 尽早集成：不需要总是等待⼀个模块开发完成才把它集成起来,⽽是在开发之初就利⽤ Stub 集成起来。
- 频繁集成：开发者每次完成⼀些开发任务之后,就可以⽤开发结果替换 Stub 中的相 应组件,进⾏集成与测试。⼀般来说,每⼈每天⾄少集成⼀次,也可以多次。

# 体系结构⽂档化

体系结构设计⽂档模版 IEEE1471-2000

评审方法：ATAM