---
aliases: 
tags: 
categories:
sticky:
thumbnail:
cover: 
excerpt: false
mathjax: true
comment: true
title: 07-SQL优化的基础
date:  2024-05-13 14:05
modified:  2024-05-13 14:05
---


**关系代数核心**：等价变换->可以自动对表达式做等价变换，做查询路径优化

# SQL与查询优化器

group by, order by不属于关系代数，无法被查询优化器优化

- 过程
	1. 优化器借助关系理论提供的语义无误的原始查询进行**有效的等价变换**
	2. 优化器根据数据库的实际情况对理论上等价的不同优化方案**做出权衡**
	3. 产生可能的**最优查询执行方案**
	4. 实际将一个SQL查询优化成更高效的方案

- 类型
	1. RBO基于规则的优化器：给每个算子赋值一个权重，计算整个查询的总权重
	2. CBO基于成本的优化器：还要考虑结果集大小
		- 优化目标：中间结果集的数量最少

## 基于成本的优化


### 优化主要方向-连接

驱动表T1执行一次，被驱动表T2执行T1的扇出次
![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2024%2F05%2F13%2F14-35-14-f6afd0bad0226e9242274e5f936168f0-20240513143513-c05bd0.png)


左外连接
右外连接
T1 T2左外连接，T1记录都保留，T2如果没有相等的，结果集中是空值


基于索引的连接优化：通过索引读取有限条的T2数据与T1连接

基于块的连接优化：

### 连接小结：

本质上，连接就是把各个表中的路径都取出来依次进行匹配，并把匹配的组合返回
外连接和内连接的本质都是确定驱动表
嵌套循环连接算法：驱动表连接一次，但被驱动表可能会访问多次，访问次数取决于被驱动表执行单表查询后结果集中有多少记录
被驱动表会被连接多次，可以用索引加速

### 成本计算

I/O成本
CPU成本
...



### 基于成本的优化步骤

1. 根据搜索条件，找出所有可能使用的索引
2. 计算全表扫描的代价(row, data_length)
3. 计算使用不同索引的代价
