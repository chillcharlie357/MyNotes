---
aliases: 
tags: 
categories:
sticky:
thumbnail:
cover: 
excerpt: false
mathjax: true
comment: true
title: 04-B树结构的物理实现
date:  2024-04-01 13:04
modified:  2024-04-01 15:04
---

# 二进制编码

- 固定大小，编解码使用相同的字节序

大端：高位在低字节，符合人类习惯  
小端：高位在高字节，加法运算方便

![32bit-Endianess.svg](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2024%2F04%2F01%2F14-10-33-387d6897a375b5a1ccbe633784039722-32bit-Endianess-d4424d.svg)

[encoding - What is the difference between utf8mb4 and utf8 charsets in MySQL? - Stack Overflow](https://stackoverflow.com/questions/30074492/what-is-the-difference-between-utf8mb4-and-utf8-charsets-in-mysql)

# 数据库文件物理组织形式通用原理

## 确定寻址方式

1. 文件拆分成大小相同的(page)，单个块(block)或连续块(multiple block)组成
2. 相同大小的page，目的是简化读取和写入访问，按页写入，从内存写到磁盘

数据存储结构一般分为两类：**原地更新**、**仅追加**通常都是按照页进行组织。

数据库的表结构一般是固定的，指定字段的数量、顺序和类型。元数据放在page的头部。

## 定长：页的结构

顺序的(key,value,pointer)

## 变长

### 分槽页（slotted page）

- 前面的**指针**按顺序，后面具体存值的**单元格**不按顺序（从后往前放，两块区域相遇说明放满了）

- 实现了：
	1. 最小开销：唯一的额外开销是指针
	2. 空间回收：页的碎片整理和重写
	3. 动态布局：外部只能通过page id引用，确切位置由页内决定

![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2024%2F04%2F01%2F14-37-23-53fecd9430ae797f555bb6f9ed36eeed-20240401143722-fdacc7.png)

### 管理变长数据(del/modify)

构建free block，并指向第一个空闲块的指针保存在页头部，并保存可用字节数

- 使用空闲块的策略
	1. 首次适配优先：找到第一个适配的空闲块
	2. 最佳适配优先：找到一个剩余段最小的空闲块

## 版本

1. 文件名带版本前缀
2. 版本使用专门文件存储，postgreSQL存在PG_VERSION
3. 直接存在每一个具体文件（索引）的头部，头部按照不变式编码

## 页头

- 保存关于用于页定位，维护和优化的信息。

### Magic Numbers

- 多字节的常量数值
	- 标志：后面是一个page
	- 标识：指定页的类型或者标识其版本
	- 意义：验证页加载和对齐是否正确

### 同级指针 Sibling Links

### 节点高键 High Keys

## 溢出页 Overflow Pages

节点大小和树的扇出是固定的  
溢出页在B树上没有限制，但是在基本表上有限制


# 分裂与合并

- 分裂与合并都从叶节点发起，向上传递，**需要一条从叶节点返回跟节点的路径**
- 实现方式：
	1. 功能上实现：用一个栈记录路径
	2. 结构上实现：在页头里放一个指向父节点的指针的字段(引入冗余需要保证一致性)


# 再平衡 

- 为了推迟分裂，减少频繁的分裂和合并。

- 再平衡
	1. 提高平均占用率
	2. 但需要额外跟踪和平衡
	3. 更高的利用率意味着更高效的搜索

# 右侧追加

直接往后延

- 自增数值作为主索引的优势在优化方面
	- 所有的插入都在所有的末尾（最右边的叶子），大量的分裂集中在每层的最右边

- 特征，在非自增数值做主索引中应用
	- 批量加载，重新构建（批处理，自下而上构建树，按层写入）
	- 不可变B+树

# 压缩

本质也是一种平衡，访问速度vs压缩率


