# 嵌入式软件软件架构

1. 业务逻辑
2. 实时依赖硬件的逻辑

移植很重要，因为嵌入式平台很多。

![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F23%2Fc20c1ac5f4bc3df54353a1b6adfe3999_20231023102928.png)
抽象层将所需操作的高级请求转换为操作所需的低级命令

# 嵌入式软件架构模式

## 非结构化单体架构

1. 很容易构建，但很难维持规模和移植
2. 和应用层的应用程序紧密耦合

![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F23%2Ff428f40da33f3eb734968e0818e925b1_20231023102633.png)

## 分层架构

1. 如今嵌入式应用程序最常用的架构
2. 将应用程序的逻辑划分为若干独立层，仅通过定义良好的抽象层进行交互
3. 试图通过将应用程序分解为独立的层来改善非结构化单体架构的高耦合性

![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F23%2F52234cc5d6dfafe6a83cc418b26533ab_20231023102955.png)

## 事件驱动架构

- 对于实时嵌入式应用程序和能耗相关的应用程序非常有意义
- 常用**中断来响应事件**
- 事件驱动的体系结构通常使用消息队列、信号量和事件标志来表示系统 中发生了事件

- 优点
	- 具有相对的可扩展性
	- 软件模块通常具有高内聚性
	- 具有低耦合
- 缺点
	- 无论要做任何事情，都需要额外开销和复杂性

 ![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F23%2Fb421fdab5c5b283656a20d00f56656ef_20231023103638.png)

## 微服务架构

- 微服务架构将应用程序构建为业务领域开发的小型自治服务的集合
- 本质：低耦合，使得微服务易于维护和可测试，开发人员可以快速扩展和一直微服务
- 围绕系统业务逻辑组织的。业务逻辑是视图行为的业务规则和用例

![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F23%2F06bad78c3130dc45e0498e72861162e3_20231023103943.png)

- 不足
	1. 在架构上，增加设计的复杂性
	2. 其次，由于具有其他体系结构中可能不需要的通信特性，它们可能会增加额外的开销和内存需求
	3. 架构的分散性也意味着实时的、确定性的行为可能更具挑战性。实时和响应可能有额外的抖动
	4. 可能会增加开发时间和预算


## 微内核架构


- 微内核架构（Microkernel Architecture），也称插件化架构（Plugin Architecture），是一种面向功能拆分的可扩展性架构
- 包含两类组件
	1. 核心系统（core system）
	2. 插件系统（plug-in modules）
- 优点
	- 微内核天生具备的模块化解耦、弹性部署的能力以及安全稳定的特 性，非常符合物联网的发展
- 缺点
	- 进程间通信（IPC Inter Process Communication）的性能无疑成为 微内核的软肋

# 常用设计模式

1. 单核
2. 多核
3. 发布和订阅模型
4. RTOS模式
5. 处理中断和低功耗设计

# 管理外设数据

- 主要的设计理念之一是**数据决定设计**。在设计嵌入式软件时，必须遵循数据。

- 设计机制
	1. 轮询
	2. 中断
	3. 直接存储访问DMA

## 轮询


- 优先级：无
- 响应时间：所有任务的总和
- 变化的影响：显著，修改任务的执行时间或添加任务会影响所有其他任务
- 优点：
	- 简单，没有共享数据问题
- 缺点：
	- 浪费处理周期，在资源受限或低功耗系统中这些周期会显著增加
	- 在处理外设可能会有很多抖动和延迟

## 有限状态机

- 优先级：每个状态决定下一个状态的优先级
- 响应时间：所有任务的总和
- 变化的影响：显著，修改任务执行时间或添加任务会影响其他任务
- 简单性：没有共享数据问题

## 前后台系统

![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F23%2Fa555c5195fea3ed3315408d82ef836fb_20231023113124.png)


## 中断设计模式

多任务，可能引入竞态条件


# 数据获取/存储相关的中断设计模式

## 线性数据存储设计模式

- 中断服务程序可以直接访问的共享内存位置
- 线性数据存储可能是危险的
	- 线性数据存储是经常遇到竟态条件的地方
	- 用于存储应用程序和ISR之间的数据的共享变量也需要声明为volatile，以防止编译器优化
- 数据存储必须由互斥锁保护，以防止竞态条件

![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F23%2Fa393729db3c7f6c6504489a9e8500765_20231023114739.png)
## 乒乓缓冲区/双缓冲区设计模式

- 旨在帮助缓解数据存储遇到的一些竟态条件问题

![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F23%2Fd145c282868dedbdc8e88138c2d728b4_20231023114617.png)

## 环形缓冲区设计模式

- 环形缓冲区（Circular Buffer），也被称为循环缓冲区（Cyclic Buffer）或 者环形队列（Ring Buffer），是一种数据结构类型，它在内存中形成一个 环形的存储空间
	- 本质上就是一个数组
- 环形缓冲区的特点是其终点和起点是相连的，形成一个环状结构。这种数据结构在处理流数据和实现数据缓存等场景中具有广泛的应用
- 在中断中接收到的实时数据可以从外设中移除并存储在循环缓冲区中。因 此，中断可以尽可能快地运行，同时允许应用程序代码自行处理循环缓冲区。使用循环缓冲区有助于确保数据不丢失，中断速度快，合理地处理数据

![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F23%2F243436cf6d1e99f8573c41f20b54a576_20231023115643.png)
