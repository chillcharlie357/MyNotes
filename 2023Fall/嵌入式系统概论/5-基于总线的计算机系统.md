# 输入输出

- I/O接口为了充当设备与计算机的桥梁，需要多个控制器
	- 数据寄存器
	- 控制寄存器
	- 状态寄存器

## 分类

### 从属关系

1. 系统设备：在OS中注册的标准设备
	- 用户只需调用OS提供命令或函数
	- NOR/NAND闪存，触摸面板等
2. 用户设备：OS启动时未注册的非标准设备
	- 驱动程序用户提供

### 使用

1. 专业设备
2. 共享设备
3. 虚拟设备

### 特征

1. 存储设备
2. I/O设备

### 信息传输单元

1. 块设备：以数据块为单位组织和交换数据
	- 例：硬盘
	- 结构化设备
	- 在I/O操作中，即使只是一个单字节的读/写，也应该读或写整个数据 块
2. 字符设备
	- 非结构化设备
	- 例：打印机、串口、触摸面板
	- 字符设备的基本特征是传输速率低且不可寻址，当字符设备执行I/O 操作时，经常使用中

## 应用：8251 UART

- 通用异步收发器，Universal asynchronous receiver transmitter (UART)
	- 包括了RS232、RS449、RS423、RS422和RS485等接口标准 规范和总线标准规范，即UART是异步串行通信口的总称
	- 规定了通信口的电器特性、传输速率、链接特性和接口的机械特性等内容

## 可编程I/O

- 在通信过程中选择控制寄存器或数据缓冲区的三种方法
	- 独立I/O端口
	- 内存映射I/O
	- 混合解决方案，混合模型包括内存映射的I/O数据缓冲区和用于控制寄存器的独立I/O端口

区别：I/O与内存**是否独立编址**

![Pasted image 20231009103553](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F09%2Fec645404d43f497e6f176362a8f6027d_Pasted%20image%2020231009103553.png)

### 独立IO

- 优点：
	- I/0独立编址，不占用内存空间
	- 使用I/O指令，程序清晰，很容易看出是I/O操作还是存储器操作
	- 译码电路比较简单(因为I/0端口的地址空间一般较小，所用地址线也就较少)
- 缺点：
	- 只能用专门的I/0指令，访问端口的方法少


### 内存映射IO

- 优势
	- 直接用内存地址访问，统一寻址
	- 不需要特殊的保护机制来组织用户的IO操作
- 缺点：
	- 内存缓存，导致延迟。硬件必须提供缓存禁用的功能，嵌入式系统设计更复杂
	- 给定一个地址空间，必须检查属于IO还是内存，严重印象系统性能


# 简单的ISR调试

不！！！
如果您的ISR只有10或20行代码，肉眼检查一下就可以，不要启动各种复杂和不可预测的工具
保持处理程序的简单和简短

# 可重入

可重入：被中断之后可以再次执行

## 条件

1. 原子方式使用所有共享变量，
2. 不调用不可重入函数
	- 继承性：调用函数继承了被调用函数的可重入问题
3. 不以非原子方式使用硬件
	- 硬件看起来像是一个变量

## 原子变量

- 不可分割，即不能被中断的操作

- 例子：
	- mov ax , bx 是
	- temp = a;a=b;b=temp 不是

## 消除不可重用

1. 避免使用共享变量
2. 禁用中断
3. 信号量

## 异步硬件/固件

```
int timer_hi;
interrupt timer(){
 ++timer_hi;}
 
long timer_read(void){
 unsigned int low, high;
 low =inword(hardware_register);
 high=timer_hi;
 return (high<<16+low);}
```

## 竞态条件

- 设备或系统出现不恰当的执行时序，而得到不正确的结果

- timer_read的竞争条件之一可能是:
	- 读取硬件，然后得到值0Xffff
	- 在从变量timer_hi中获取时间的高十六位数值之前，硬件再次增加，到0x0000
溢出触发中断，ISR运行，此时timer_hi是0
0001，而不是几纳秒之前的0
ISR返回；timer_read例程，不知道发生了中断，只是将新的0001
与先前读取的定时器值0Xffff，并返回0x1ffff，一个非常不正确的值

# AMBA总线

AHB(Advanced High-performance Bus) 高级高性能总线
主要是针对高效率、高频宽及快速系统模块所设计的总线，它可以连接如微处
理器、芯片上或芯片外的内存模块和DMA等高效率模块
APB (Advanced Peripheral Bus) 高级外围总线
速度更慢，成本更低，主要用在低速且低功率的外围，可针对外围设备作功率
消耗及复杂接口的最佳化，APB在AHB和低带宽的外围设备之间提供了通信
的桥梁
AXI （Advanced eXtensible Interface） 高级可拓展接口
AXI是在AMBA3.0的协议中增加的，可以用于ARM和FPGA的高速数据交互
高速度、高带宽，管道化互联，单向通道，只需要首地址，读写并行，支持乱
序，支持非对齐操作，有效支持初始延迟较高的外设，连线非常多。

![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F16%2F1bf19e2f4659f6ee8d7d248b55c57b9d_20231016105637.png)



# 常用总线

![image.png](https://chillcharlie-img.oss-cn-hangzhou.aliyuncs.com/image%2F2023%2F10%2F16%2F64ebf530f7ce654a1bbbb89d6118ba54_20231016105851.png)
